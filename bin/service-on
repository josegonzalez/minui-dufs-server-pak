#!/bin/sh
bindir="$(dirname "$0")"
progdir="$(dirname "$bindir")"
cd "$progdir" || exit 1
PAK_NAME="$(basename "$progdir")"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$progdir/lib"

main() {
    cd "$SDCARD_PATH" || exit 1
    if [ -f "$LOGS_PATH/$PAK_NAME.service.log" ]; then
        mv "$LOGS_PATH/$PAK_NAME.service.log" "$LOGS_PATH/$PAK_NAME.service.log.old"
    fi

    port=""
    if [ -f "$progdir/port" ]; then
        port="$(cat "$progdir/port")"
    fi
    if [ -z "$port" ]; then
        port=80
    fi

    chmod +x "$progdir/bin/dufs"
    "$bindir/dufs" --allow-all --bind 0.0.0.0 --port "$port" --log-file "$LOGS_PATH/$PAK_NAME.service.log" &
}

main "$@"
